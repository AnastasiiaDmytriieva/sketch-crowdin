<html>

<head>
    <link rel="stylesheet" href="../bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../bootstrap-select/dist/css/bootstrap-select.min.css">
    <link rel="stylesheet" href="../styles.css">
    <script src="../popper.js/dist/umd/popper.min.js"></script>
    <script src="../jquery/dist/jquery.min.js"></script>
    <script src="../bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="../bootstrap-select/dist/js/bootstrap-select.min.js"></script>
</head>

<body>
    <div class="main-container">
        <nav class="navbar navbar-expand navbar-light plugin-tabs">
            <div class="container-fluid">
                <ul class="nav navbar-nav native-tabs">
                    <li class="nav-item" data-toggle="tooltip" data-id="settings" placement="bottom"
                        crowdin-ui-text-details="translationsDetails">
                        <a crowdin-ui-text-label="translationTab" id="translation-nav" class="nav-link" href="#"
                            onclick="openModal('translation');"></a>
                    </li>
                    <li class="nav-item" data-toggle="tooltip" data-placement="bottom"
                        crowdin-ui-text-details="stringsDetails">
                        <a crowdin-ui-text-label="stringsTab" id="strings-mode-nav" class="nav-link" href="#"
                            onclick="openModal('strings-mode');"></a>
                    </li>
                    <li class="nav-item">
                        <a crowdin-ui-text-label="settingsTab" id="settings-nav" class="nav-link active" href="#"
                            onclick="openModal('settings');"></a>
                    </li>
                </ul>
                <ul class="nav navbar-nav navbar-right pr-2">
                    <a crowdin-ui-text-label="contactUsTab" class="link small" href="#" onclick="contactUsClick()"></a>
                </ul>
            </div>
        </nav>
        <main role="main">
            <div class="container" id="settings">
                <form>
                    <div class="form-group inline-select d-flex flex-row">
                        <label crowdin-ui-text-label="selectProjectLabel"></label>
                        <div class="inline-select-holder ml-2">
                            <select id="projects" onchange="onUpdateProject()"></select>
                        </div>
                    </div>
                    <fieldset class="mt-4">
                        <label crowdin-ui-text-label="connectionDetailsLabel" class="fieldset-label"></label>
                        <div class="form-group">
                            <label crowdin-ui-text-label="tokenLabel"></label>
                            <input type="text" class="form-control" id="token"
                                onchange="$('#connect-btn').attr('disabled', false);">
                            <p crowdin-ui-text-label="tokenDetailsText" class="form-text text-muted help-text mb-3">
                            </p>
                        </div>
                        <div class="form-group">
                            <label crowdin-ui-text-label="organizationLabel"></label>
                            <input type="text" class="form-control" id="organization"
                                onchange="$('#connect-btn').attr('disabled', false);">
                            <p crowdin-ui-text-label="organizationDetailsText" class="form-text text-muted help-text">
                            </p>
                            <button id="connect-btn" crowdin-ui-text-label="connectToCrowdinButton" type="button"
                                class="btn btn-primary btn-sm" onclick="saveCredentials()"></button>
                            <button id="logout-btn" crowdin-ui-text-label="logoutButton" type="button"
                                class="btn btn-secondary btn-sm float-right" onclick="logout()"></button>
                        </div>
                    </fieldset>
                    <fieldset class="mt-4">
                        <label crowdin-ui-text-label="advancedSettingsLabel" class="fieldset-label"></label>
                        <div class="adv-settings-container">
                            <div class="form-group mb-3">
                                <div>
                                    <label crowdin-ui-text-label="overrideTranslationsLabel" class="mb-0">
                                    </label>
                                    <input type="checkbox" class="ml-1 mt-1" id="overrideTranslations"
                                        onchange="saveOverrideTranslations()">
                                </div>
                                <p crowdin-ui-text-label="overrideTranslationsText"
                                    class="form-text text-muted help-text">
                                </p>
                            </div>
                            <div class="form-group mb-3">
                                <div>
                                    <label crowdin-ui-text-label="contentSegmentationLabel" class="mb-0">
                                    </label>
                                    <input type="checkbox" class="ml-1 mt-1" id="contentSegmentation"
                                        onchange="saveContentSegmentation()">
                                </div>
                                <p crowdin-ui-text-label="contentSegmentationText"
                                    class="form-text text-muted help-text">
                                </p>
                            </div>
                            <div class="form-group">
                                <div class="inline-select d-flex flex-row">
                                    <label crowdin-ui-text-label="stringsKeyNamingLabel"></label>
                                    <div class="inline-select-holder ml-2">
                                        <select id="stringsKeyNaming" onchange="saveKeyNamingOption()">
                                        </select>
                                    </div>
                                </div>
                                <p crowdin-ui-text-label="stringsKeyNamingText" class="form-text text-muted help-text">
                                </p>
                            </div>
                            <div class="form-group">
                                <div class="inline-select d-flex flex-row">
                                    <label crowdin-ui-text-label="selectBranchLabel"></label>
                                    <div class="inline-select-holder ml-2">
                                        <select id="branches" onchange="saveBranch().then(clearStorage)"></select>
                                    </div>
                                </div>
                                <p crowdin-ui-text-label="branchText" class="form-text text-muted help-text">
                                </p>
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>

            <div class="container" id="strings-mode" style="display: none;">
                <form>
                    <div class="form-group list-strings-holder mb-4" id="list-strings">
                        <div>
                            <button type="button" class="btn btn-secondary btn-sm btn-bottom float-right ml-2"
                                onclick="openAddString();">
                                <svg class="btn-icon" width="13" height="13" viewBox="0 0 13 13" fill="currentColor"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M7 1H6V6H1V7H6V12H7V7H12V6H7V1Z"
                                        fill="currentColor" />
                                </svg>
                                <span crowdin-ui-text-label="addStringButton"></span>
                            </button>
                            <p class="form-text" crowdin-ui-text-label="useStringDetailsText">
                            </p>
                        </div>
                        <div class="row">
                            <div class="col-11">
                                <div class="search-wrapper">
                                    <input type="search" id="search-text" class="w-100" oninput="debounceSearch()"
                                        placeholder="Search">
                                </div>
                            </div>
                            <div class="col-1 strings-reload">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"
                                    fill="currentColor" class="float-right" style="cursor: pointer;"
                                    onclick="reloadStrings();">
                                    <title crowdin-ui-text-label="stringsReloadButtonLabel"></title>
                                    <path fill-rule="evenodd"
                                        d="m8,1.5a6.491,6.491 0 0 0 -5.285,2.715l1.358,1.358a0.25,0.25 0 0 1 -0.177,0.427l-3.646,0a0.25,0.25 0 0 1 -0.25,-0.25l0,-3.646a0.25,0.25 0 0 1 0.427,-0.177l1.216,1.216a8,8 0 0 1 14.315,4.03a0.748,0.748 0 0 1 -0.668,0.83a0.75,0.75 0 0 1 -0.824,-0.676a6.501,6.501 0 0 0 -6.466,-5.827zm-7.288,6.504a0.75,0.75 0 0 1 0.822,0.67a6.501,6.501 0 0 0 11.751,3.111l-1.358,-1.358a0.25,0.25 0 0 1 0.177,-0.427l3.646,0a0.25,0.25 0 0 1 0.25,0.25l0,3.646a0.25,0.25 0 0 1 -0.427,0.177l-1.216,-1.216a8,8 0 0 1 -14.315,-4.03a0.75,0.75 0 0 1 0.67,-0.823z">
                                    </path>
                                </svg>
                            </div>
                        </div>

                        <div id="strings-container" class="strings-container mt-3 bordered">
                        </div>
                    </div>
                    <fieldset id="edit-string" class="edit-string-mode" style="display: none;">
                        <div id="single-string-form">
                            <div class="form-group">
                                <label><abbr crowdin-ui-text-label="addStringStringLabel"
                                        crowdin-ui-text-details="addStringStringDetails"></abbr></label>
                                <textarea class="form-control" id="string-text" placeholder="text"></textarea>
                                <div class="invalid-feedback" id="invalidString"></div>
                            </div>
                            <div id="new-string-form" style="display: none;">
                                <div class="form-group">
                                    <label><abbr crowdin-ui-text-details="addStringIdentifierDetails"
                                            crowdin-ui-text-label="addStringIdentifierLabel"></abbr></label>
                                    <input class="form-control" id="string-identifier" placeholder="identifier"
                                        type="text">
                                    <div class="invalid-feedback" id="invalidIdentifier"></div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-8 col-form-label" for="string-max-length"><abbr
                                            crowdin-ui-text-label="addStringMaxLengthLabel"
                                            crowdin-ui-text-details="addStringMaxLengthDetails"></abbr></label>
                                    <div class="col-4">
                                        <input min="0" type="number" class="form-control" id="string-max-length">
                                        <div class="invalid-feedback" id="invalidMaxLength"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="multi-string-form" class="multi-add-string-form-container" style="display: none;">
                            <div class="multi-strings-form__header row">
                                <label crowdin-ui-text-label="addStringStringLabel" class="col"></label>
                                <label crowdin-ui-text-label="addStringIdentifierLabel" class="col"></label>
                            </div>
                            <div class="strings-holder"></div>
                        </div>
                        <div id="string-file-container" class="form-group mt-2">
                            <label for="string-files"><abbr crowdin-ui-text-label="addStringFileLabel"
                                    crowdin-ui-text-details="addStringFileDetails"></abbr></label>
                            <select class="form-control" id="string-files" multiple size="8"></select>
                            <div class="invalid-feedback" id="invalidFile"></div>
                        </div>
                        <div id="string-label-container" class="form-group mt-2">
                            <label for="string-labels"><abbr crowdin-ui-text-label="addStringLabelLabel"
                                    crowdin-ui-text-details="addStringLabelDetails"></abbr></label>
                            <select class="form-control" id="string-labels" multiple size="8"></select>
                        </div>
                        <div class="button-holder d-flex flex-row">
                            <button crowdin-ui-text-label="addStringSaveButtonLabel" type="button"
                                class="btn btn-primary btn-sm" onclick="saveString();"></button>
                            <button crowdin-ui-text-label="addStringCancelButtonLabel" type="button"
                                class="btn btn-secondary btn-sm ml-2" onclick="cancelEditString();"></button>
                            <button id="string-delete-btn" crowdin-ui-text-label="addStringDeleteButtonLabel"
                                type="button" class="btn btn-secondary btn-sm ml-auto"
                                onclick="deleteString();"></button>
                        </div>
                    </fieldset>
                    <div id="strings-preview">
                        <fieldset>
                            <label crowdin-ui-text-label="previewStringsLabel" class="fieldset-label"></label>
                            <div class="form-group">
                                <p crowdin-ui-text-label="previewStringsDetailsText" class="form-text"></p>
                                <div class="form-row">
                                    <div class="col-6">
                                        <select id="languages-preview" class="ml-1"></select>
                                    </div>
                                    <div class="col-3">
                                        <button crowdin-ui-text-label="previewAllButtonLabel" type="button"
                                            class="btn btn-secondary btn-sm btn-block"
                                            onclick="stringsPreview(true)"></button>
                                    </div>
                                    <div class="col-3">
                                        <button crowdin-ui-text-label="previewSelectedButtonLabel" type="button"
                                            class="btn btn-secondary btn-sm btn-block"
                                            onclick="stringsPreview(false)"></button>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                        <fieldset>
                            <label crowdin-ui-text-label="uploadScreenshotsLabel" class="fieldset-label"></label>
                            <div class="form-group">
                                <p crowdin-ui-text-label="uploadScreenshotsDetailsText" class="form-text"></p>
                                <button crowdin-ui-text-label="uploadScreenshotsButtonLabel" type="button"
                                    class="btn btn-secondary btn-sm mb-2" onclick="uploadScreenshots()"></button>
                            </div>
                        </fieldset>
                    </div>
                </form>
            </div>

            <div class="container" id="translation" style="display: none;">
                <form>
                    <fieldset>
                        <label crowdin-ui-text-label="sendTextsLabel" class="fieldset-label"></label>
                        <div class="form-group">
                            <label crowdin-ui-text-label="sendTextsForLabel"></label>
                            <div class="form-row">
                                <div class="col">
                                    <button crowdin-ui-text-label="sendTextsForPageButtonLabel" type="button"
                                        class="btn btn-secondary btn-sm btn-block" onclick="sendStrings(true)"></button>
                                </div>
                                <div class="col">
                                    <button crowdin-ui-text-label="sendTextsForArtboardButtonLabel" type="button"
                                        class="btn btn-secondary btn-sm btn-block"
                                        onclick="sendStrings(false)"></button>
                                </div>
                            </div>
                        </div>
                    </fieldset>
                    <fieldset>
                        <label crowdin-ui-text-label="getTranslationsLabel" class="fieldset-label"></label>
                        <div class="form-group">
                            <label crowdin-ui-text-label="getTranslationsLanguageLabel"></label>
                            <select id="languages" class="ml-1"></select>
                        </div>
                        <div class="form-group">
                            <label crowdin-ui-text-label="uploadTranslationsLabelFor"></label>
                            <div class="form-row">
                                <div class="col">
                                    <button crowdin-ui-text-label="uploadTranslationsForPageButtonLabel" type="button"
                                        class="btn btn-secondary btn-sm btn-block"
                                        onclick="translateComponent(true)"></button>
                                </div>
                                <div class="col">
                                    <button crowdin-ui-text-label="uploadTranslationsForArtboardButtonLabel"
                                        type="button" class="btn btn-secondary btn-sm btn-block"
                                        onclick="translateComponent(false)"></button>
                                </div>
                            </div>
                        </div>
                    </fieldset>

                </form>
            </div>

            <div id="spinner" class="modal fade bd-example-modal-lg show" data-backdrop="static" data-keyboard="false"
                tabindex="-1" style="display: none;" aria-modal="true">
                <div class="modal-dialog modal-sm">
                    <div class="modal-content" style="width: 48px">
                        <div class="spinner-border" role="status">
                            <span crowdin-ui-text-label="loadingDialog" class="sr-only"></span>
                        </div>
                    </div>
                </div>
            </div>


        </main>
        <div class="push"></div>
    </div>
    <div class="footer" id="footer"></div>
    <div id="modalFade" class="modal-backdrop fade show" style="display: none;"></div>
</body>

<script>

    const editableFileTypes = ['csv', 'resx', 'json', 'android', 'macosx', 'strings', 'properties', 'xliff'];

    //initial view
    var openedModal = 'settings';

    //initialization of the settings modal
    showLoading();
    getCredentials()
        .then(getOverrideTranslations)
        .then(getContentSegmentation)
        .then(getKeyNamingOptions)
        .then(getProjects)
        .then(getBranches)
        .finally(hideLoading);

    var validationMessages = {};
    var allLanguagesOption;
    var noBranchOption;

    var languages;
    var strings;
    var files;
    var labels;
    var openedString;
    var selectedText = [];

    //basic functions

    function clearStorage() {
        strings = undefined;
        languages = undefined;
        files = undefined;
        labels = undefined;
        openedString = undefined;
        selectedText.length = 0;
    }

    function openModal(modal) {
        if (openedModal === modal) {
            return;
        }
        $(`#${openedModal}`).hide();
        $(`#${openedModal}-nav`).removeClass('active');
        $(`#${modal}`).show();
        $(`#${modal}-nav`).addClass('active');
        openedModal = modal;
        switch (modal) {
            case 'strings-mode':
                openStringsMode();
                break;
            case 'translation':
                cancelEditString();
                openTranslationsTab();
                break;
            case 'settings':
                cancelEditString();
                break;
        }
    }

    function contactUsClick() {
        window.postMessage('contactUs');
    }

    function openTranslationsTab() {
        if (!languages) {
            showLoading();
            return getLanguages()
                .finally(hideLoading);
        }
    }

    function openStringsMode() {
        if (!strings || !files || !languages || !labels) {
            showLoading();
            return getFiles()
                .then(getLabels)
                .then(getStrings)
                .then(getLanguages)
                .finally(hideLoading);
        }
    }

    function showLoading() {
        $('#spinner').show();
        $('#modalFade').show();
    }

    function hideLoading() {
        $('#spinner').hide();
        $('#modalFade').hide();
    }

    //settings

    function getCredentials() {
        return window.postMessage('getCredentials').then(creds => {
            $('#organization').val(creds[0].organization);
            $('#token').val(creds[0].token);
            $('#connect-btn').attr('disabled', !!creds[0].token);
            $('#logout-btn').attr('disabled', !creds[0].token);
        });
    }

    function saveCredentials() {
        showLoading();
        const token = $('#token').val();
        const organization = $('#organization').val();
        $('#connect-btn').attr('disabled', true);
        $('#logout-btn').attr('disabled', false);
        return window.postMessage('saveCredentials', { token, organization })
            .then(getCredentials)
            .then(getProjects)
            .then(saveProject)
            .then(getBranches)
            .then(saveBranch)
            .then(clearStorage)
            .finally(hideLoading);
    }

    function logout() {
        window.postMessage('logout').then(() => location.reload());
    }

    function onUpdateProject() {
        showLoading();
        return saveProject()
            .then(getBranches)
            .then(saveBranch)
            .then(clearStorage)
            .finally(hideLoading);
    }

    function saveProject() {
        const projectId = $('#projects option:selected').val();
        return window.postMessage('saveProject', projectId);
    }

    function saveBranch() {
        const branchId = Number($('#branches option:selected').val());
        return window.postMessage('saveBranch', branchId);
    }

    function saveOverrideTranslations() {
        return window.postMessage('saveOverrideTranslations', $('#overrideTranslations').prop('checked'));
    }

    function saveContentSegmentation() {
        return window.postMessage('saveContentSegmentation', $('#contentSegmentation').prop('checked'));
    }

    function saveKeyNamingOption() {
        const option = Number($('#stringsKeyNaming option:selected').val());
        return window.postMessage('saveKeyPatternOption', option);
    }

    //translation

    function translateComponent(wholePage) {
        showLoading();
        const languageId = $('#languages option:selected').val();
        return window.postMessage('translate', languageId, wholePage).finally(hideLoading);
    }

    function sendStrings(wholePage) {
        showLoading();
        return window.postMessage('sendStrings', wholePage).finally(hideLoading);
    }

    //strings mode

    function useString(e) {
        showLoading();
        const id = Number($(e).attr('int-id'));
        const identifier = $(e).attr('str-id');
        const text = $(e).text().trim();
        return window.postMessage('useString', [{ id, text, identifier }])
            .then(e => {
                if (!e[0].error) {
                    markAsUsed(id);
                    e[0].stringsToDeselect.forEach(markAsUnused);
                }
            })
            .finally(hideLoading);
    }

    function deselectString(e) {
        showLoading();
        const id = Number($(e).attr('int-id'));
        return window.postMessage('deselectString', id)
            .then(e => {
                if (!e[0].error) {
                    markAsUnused(id);
                }
            })
            .finally(hideLoading);
    }

    function uploadScreenshots() {
        showLoading();
        return window.postMessage('uploadScreenshots').finally(hideLoading);
    }

    function stringsPreview(wholePage) {
        showLoading();
        const id = $('#languages-preview option:selected').val();
        const name = $('#languages-preview option:selected').text();
        return window.postMessage('stringsPreview', { id, name }, wholePage).finally(hideLoading);
    }

    function reloadStrings() {
        strings = undefined;
        files = undefined;
        labels = undefined;
        showLoading();
        return getFiles()
            .then(getLabels)
            .then(getStrings)
            .finally(hideLoading);
    }

    //strings management

    function openEditString(element) {
        $('#string-delete-btn').show();
        const el = $(element);
        $('#list-strings').hide();
        $('#strings-preview').hide();
        $('#new-string-form').hide();
        $('#multi-string-form').hide();
        $('#string-file-container').hide();
        $('#string-label-container').hide();
        $('#single-string-form').show();
        $('#edit-string').show();
        const text = el.next().text().trim();
        const id = Number(el.next().attr('int-id'));
        $('#string-text').val(text);
        openedString = id;
    }

    function openAddString() {
        $('#string-delete-btn').hide();
        showLoading();
        window.postMessage('getSelectedText').then((e) => {
            selectedText = e[0];
            $('#list-strings').hide();
            $('#strings-preview').hide();
            $('#new-string-form').show();
            $('#string-file-container').show();
            $('#string-label-container').show();
            $('#edit-string').show();
            if (selectedText.length === 0) {
                $('#string-text').val('');
                $('#string-identifier').val('');
                $('#string-max-length').val('');
                $('#multi-string-form').hide();
                $('#single-string-form').show();
            } else if (selectedText.length === 1) {
                $('#string-text').val(selectedText[0].text);
                $('#string-identifier').val(generateIdentifier(selectedText[0], (strings || []).map(s => s.identifier)));
                $('#string-max-length').val('');
                $('#multi-string-form').hide();
                $('#single-string-form').show();
            } else {
                let rowsHtml = '';
                let identifiers = (strings || []).map(s => s.identifier);
                selectedText.forEach(e => {
                    const identifier = generateIdentifier(e, identifiers);
                    identifiers.push(identifier);
                    rowsHtml += `
                    <div class="form-row">
                        <div class="col">
                            <textarea class="form-control" placeholder="text">${e.text}</textarea>
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col">
                            <input type="text" class="form-control" placeholder="identifier" value="${identifier}">
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>
                    `;
                });
                const html = `<div class="form-group">${rowsHtml}</div>`;
                $('#multi-string-form .strings-holder').empty();
                $('#multi-string-form .strings-holder').append(html);
                $('#single-string-form').hide();
                $('#multi-string-form').show();
            }
            openedString = undefined;
            hideLoading();
        });
    }

    function generateIdentifier(selectedTextElement, identifiers) {
        const pattern = $('#stringsKeyNaming option:selected').text();
        const artboardName = selectedTextElement.artboard.toLowerCase();
        const groupName = selectedTextElement.group.toLowerCase();
        const elementName = selectedTextElement.elementName.toLowerCase();
        const artboardNameUpperCase = capitalizeFirstLetter(artboardName);
        const groupNameUpperCase = capitalizeFirstLetter(groupName);
        const elementNameUpperCase = capitalizeFirstLetter(elementName);
        const identifier = smartReplace(pattern, {
            'Artboard': artboardNameUpperCase,
            'artboard': artboardName,
            'Group': groupNameUpperCase,
            'group': groupName,
            'Element_name': elementNameUpperCase,
            'element_name': elementName
        });
        let uniqueIdentifier = identifier;
        //make unique
        let increment;
        for (; ;) {
            if (identifiers.some(i => i === uniqueIdentifier)) {
                increment = !!increment ? (increment + 1) : 1;
                uniqueIdentifier = identifier + increment;
            } else {
                break;
            }
        }
        return uniqueIdentifier;
    }

    function smartReplace(pattern, obj) {
        const replacing = {};
        for (let x in obj) {
            if (pattern.indexOf(x) > -1) {
                replacing[pattern.indexOf(x)] = {
                    to: x.length + pattern.indexOf(x),
                    by: obj[x]
                };
            }
        }
        let result = '';
        for (let i = 0; i < pattern.length; i++) {
            let replaced = false;
            for (let replacingIndex in replacing) {
                if (Number(replacingIndex) === i) {
                    replaced = true;
                    i = replacing[replacingIndex].to - 1;
                    result += replacing[replacingIndex].by;
                }
            }
            if (!replaced) {
                result += pattern.charAt(i);
            }
        }
        return result;
    };

    function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    }

    function cancelEditString() {
        $('#list-strings').show();
        $('#strings-preview').show();
        $('#edit-string').hide();
        $('#invalidString').text('');
        $('#invalidIdentifier').text('');
        $('#invalidMaxLength').text('');
        $('#invalidFile').text('');
        $('#string-labels').selectpicker('deselectAll');
        selectedText.length = 0;
    }

    function deleteString() {
        if (openedString) {
            showLoading();
            window.postMessage('deleteString', { id: openedString })
                .then(e => {
                    if (!e[0].error) {
                        strings = strings.filter(e => e.id !== openedString);
                        cancelEditString();
                        return search();
                    }
                })
                .finally(hideLoading);
        } else {
            cancelEditString();
        }
    }

    function saveString() {
        const identifiers = (strings || []).map(s => s.identifier);
        if (selectedText.length > 1) {
            //adding multiple strings
            $('#multi-string-form div.form-group .invalid-feedback').text('');
            const files = $('#string-files option:selected').toArray();
            const labelIds = $('#string-labels option:selected').toArray().map(l => Number($(l).val()));
            if (files.length === 0) {
                $('#invalidFile').text(validationMessages.addStringEmptyFile || 'Invalid');
                return;
            }
            const newStrings = [];
            const rows = $('#multi-string-form div.form-group div.form-row');
            for (let i = 0; i < rows.length; i++) {
                const row = $(rows[i]);
                const text = $(row.find('textarea')[0]).val();
                const identifier = $(row.find('input')[0]).val();
                if (!text || text.length === '') {
                    $(row.find('.invalid-feedback')[0]).text(validationMessages.addStringEmptyString || 'Invalid');
                    return;
                }
                if (!identifier || identifier.length === '') {
                    $(row.find('.invalid-feedback')[1]).text(validationMessages.addStringEmptyIdentifier || 'Invalid');
                    return;
                }
                if (identifiers.some(i => i === identifier)) {
                    $(row.find('.invalid-feedback')[1]).text(validationMessages.addStringNotUniqueIdentifier || 'Invalid');
                    return;
                }
                identifiers.push(identifier);
                newStrings.push({
                    text,
                    identifier,
                    selectedText: selectedText[i]
                });
            }
            showLoading();
            const addedStrings = [];
            const promises = files.map(file => {
                return newStrings.reduce((acc, str) => {
                    return acc.then(() => {
                        return window
                            .postMessage('addString', {
                                text: str.text,
                                identifier: str.identifier,
                                fileId: Number($(file).val()),
                                labelIds: labelIds.length > 0 ? labelIds : undefined
                            })
                            .then(e => {
                                if (!e[0].error) {
                                    strings.push({
                                        id: e[0].data.id,
                                        text: str.text,
                                        fileId: Number($(file).val()),
                                        identifier: str.identifier,
                                        context: str.identifier,
                                        labelIds
                                    });
                                    addedStrings.push({
                                        id: e[0].data.id,
                                        ...str
                                    });
                                }
                            })
                    });
                }, Promise.resolve());
            });
            return Promise.all(promises)
                .then(() => {
                    if (addedStrings.length > 0 && files.length === 1) {
                        return window.postMessage('useString', addedStrings);
                    }
                })
                .then(() => {
                    cancelEditString();
                    return search();
                })
                .finally(hideLoading);
        }
        $('#invalidString').text('');
        $('#invalidIdentifier').text('');
        $('#invalidMaxLength').text('');
        $('#invalidFile').text('');
        const text = $('#string-text').val();
        if (!text || text.length === '') {
            $('#invalidString').text(validationMessages.addStringEmptyString || 'Invalid');
            return;
        }
        if (openedString) {
            //editing string
            showLoading();
            return window.postMessage('editString', { id: openedString, text })
                .then(e => {
                    if (!e[0].error) {
                        strings = strings.map(s => {
                            if (s.id === openedString) {
                                s.text = text;
                            }
                            return s;
                        });
                        cancelEditString();
                        return search();
                    }
                })
                .finally(hideLoading);
        } else {
            //adding single string
            const identifier = $('#string-identifier').val();
            const maxLength = Number($('#string-max-length').val());
            const files = $('#string-files option:selected').toArray();
            const labelIds = $('#string-labels option:selected').toArray().map(l => Number($(l).val()));
            if (!identifier || identifier.length === '') {
                $('#invalidIdentifier').text(validationMessages.addStringEmptyIdentifier || 'Invalid');
                return;
            }
            if (identifiers.some(i => i === identifier)) {
                $('#invalidIdentifier').text(validationMessages.addStringNotUniqueIdentifier || 'Invalid');
                return;
            }
            if (!$('#string-max-length')[0].validity.valid) {
                $('#invalidMaxLength').text(validationMessages.addStringInvalidMaxLength || 'Invalid');
                return;
            }
            if (files.length === 0) {
                $('#invalidFile').text(validationMessages.addStringEmptyFile || 'Invalid');
                return;
            }
            showLoading();
            const promises = files.map(file => {
                const req = {
                    text,
                    identifier,
                    maxLength: $('#string-max-length').val().length === 0 ? undefined : maxLength,
                    fileId: Number($(file).val()),
                    labelIds: labelIds.length > 0 ? labelIds : undefined
                };
                return window.postMessage('addString', req)
                    .then(e => {
                        if (!e[0].error) {
                            const id = e[0].data.id;
                            strings.push({
                                id,
                                text: text,
                                fileId: Number($(file).val()),
                                identifier: identifier,
                                context: identifier,
                                labelIds
                            });
                            return id;
                        };
                    });
            });
            return Promise.all(promises)
                .then((ids) => {
                    const id = ids.find(id => !!id);
                    if (selectedText.length > 0 && files.length === 1) {
                        return window
                            .postMessage('useString', [{
                                id,
                                text,
                                identifier,
                                selectedText: selectedText[0]
                            }]);
                    }
                })
                .then(() => {
                    cancelEditString();
                    return search();
                })
                .finally(hideLoading);
        }
    }

    function markAsUsed(stringId) {
        const row = $(`p[int-id=${stringId}]`);
        if (row.length === 1) {
            const e = $(row[0]);
            e.bind('contextmenu', () => {
                deselectString(row[0]);
                return false;
            });
            $(e.prevAll('svg[checkicon]')[0]).attr('opacity', '1.0');
        }
    }

    function markAsUnused(stringId) {
        const row = $(`p[int-id=${stringId}]`);
        if (row.length === 1) {
            const e = $(row[0]);
            e.unbind('contextmenu');
            $(e.prevAll('svg[checkicon]')[0]).attr('opacity', '0.0');
        }
    }

    //data loading functions

    function getOverrideTranslations() {
        return window.postMessage('getOverrideTranslations')
            .then(msg => $('#overrideTranslations').prop('checked', !!msg[0].overrideTranslations));
    }

    function getContentSegmentation() {
        return window.postMessage('getContentSegmentation')
            .then(msg => $('#contentSegmentation').prop('checked', !!msg[0].contentSegmentation));
    }

    function getKeyNamingOptions() {
        return window.postMessage('getKeyPatternOptions')
            .then(info => {
                const options = info[0];
                const html = options.map(o => {
                    if (o.selected) {
                        return `<option value="${o.id}" selected>${o.name}</option>`;
                    } else {
                        return `<option value="${o.id}">${o.name}</option>`;
                    }
                }).join('');
                $('#stringsKeyNaming').find('option').remove().end().append(html);
            });
    }

    function getProjects() {
        return window.postMessage('getProjects')
            .then(info => {
                const projectsInfo = info[0];
                const options = projectsInfo.projects.map(pr => {
                    if (pr.id === projectsInfo.selectedProjectId) {
                        return `<option value="${pr.id}" selected></option>`;
                    } else {
                        return `<option value="${pr.id}"></option>`;
                    }
                }).join('');
                $('#projects').find('option').remove().end().append(options);
                projectsInfo.projects.forEach(pr => {
                    //adding text here via "text" method to avoid issues with strings which contain html tags
                    $('#projects').find(`option[value=${pr.id}]`).text(pr.name);
                });
            });
    }

    function getLanguages() {
        if (!languages) {
            return window.postMessage('getLanguages')
                .then(res => {
                    languages = res[0];
                    let options = `<option value="-1">${allLanguagesOption || ''}</option>`;
                    options += languages.map(lan => {
                        return `<option value="${lan.id}"></option>`;
                    }).join('');
                    $('#languages').find('option').remove().end().append(options);
                    $('#languages-preview').find('option').remove().end().append(options);
                    languages.forEach(lan => {
                        //adding text here via "text" method to avoid issues with strings which contain html tags
                        $('#languages').find(`option[value=${lan.id}]`).text(lan.name);
                        $('#languages-preview').find(`option[value=${lan.id}]`).text(lan.name);
                    });
                });
        } else {
            return new Promise((res, rej) => {
                res();
            });
        }
    }

    function getFiles() {
        if (!files) {
            return window.postMessage('getFiles')
                .then(res => {
                    files = res[0];
                    const supportedFiles = files.filter(file => editableFileTypes.includes(file.type));
                    const options = supportedFiles
                        .map(file => {
                            return `<option value="${file.id}"></option>`;
                        }).join('');
                    $('#string-files').find('option').remove().end().append(options);
                    supportedFiles.forEach(file => {
                        //adding text here via "text" method to avoid issues with strings which contain html tags
                        $('#string-files').find(`option[value=${file.id}]`).text(file.name);
                    });
                    $('#string-files').selectpicker('refresh');
                });
        } else {
            return new Promise((res, rej) => {
                res();
            });
        }
    }

    function getLabels() {
        if (!labels) {
            return window.postMessage('getLabels')
                .then(res => {
                    labels = res[0];
                    const options = labels
                        .map(label => {
                            return `<option value="${label.id}"></option>`;
                        }).join('');
                    $('#string-labels').find('option').remove().end().append(options);
                    labels.forEach(label => {
                        //adding text here via "text" method to avoid issues with strings which contain html tags
                        $('#string-labels').find(`option[value=${label.id}]`).text(label.title);
                    });
                    $('#string-labels').selectpicker('refresh');
                });
        } else {
            return new Promise((res, rej) => {
                res();
            });
        }
    }

    function getStrings() {
        if (!strings) {
            return window.postMessage('getStrings')
                .then(res => {
                    strings = res[0];
                    return search();
                });
        } else {
            return new Promise((res, rej) => {
                res();
            });
        }
    }

    function getBranches() {
        return window.postMessage('getBranches')
            .then(res => {
                var resp = res[0];
                var selectedBranch = resp.selectedBranchId;
                let options = `<option value="-1" ${selectedBranch < 0 ? 'selected' : ''}>${noBranchOption || ''}</option>`;
                options += resp.branches
                    .map(br => {
                        return `<option value="${br.id}" ${br.id === selectedBranch ? 'selected' : ''}></option>`;
                    }).join('');
                $('#branches').find('option').remove().end().append(options);
                resp.branches.forEach(br => {
                    //adding text here via "text" method to avoid issues with strings which contain html tags
                    $('#branches').find(`option[value=${br.id}]`).text(br.name);
                });
            });
    }

    var searchTimer;
    function debounceSearch() {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(search, 700);
    }

    function search() {
        const editIcon = `
            <svg class="float-right string-row-edit string-row-icon" onclick="openEditString(this);" width="16px" height="16px" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" d="M11.293 1.293a1 1 0 0 1 1.414 0l2 2a1 1 0 0 1 0 1.414l-9 9a1 1 0 0 1-.39.242l-3 1a1 1 0 0 1-1.266-1.265l1-3a1 1 0 0 1 .242-.391l9-9zM12 2l2 2-9 9-3 1 1-3 9-9z"/>
                <path fill-rule="evenodd" d="M12.146 6.354l-2.5-2.5.708-.708 2.5 2.5-.707.708zM3 10v.5a.5.5 0 0 0 .5.5H4v.5a.5.5 0 0 0 .5.5H5v.5a.5.5 0 0 0 .5.5H6v-1.5a.5.5 0 0 0-.5-.5H5v-.5a.5.5 0 0 0-.5-.5H3z"/>
            </svg>
        `;

        const checkIcon = `
            <svg checkicon class="float-left string-row-icon" width="16px" height="16px" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" d="M10.97 4.97a.75.75 0 0 1 1.071 1.05l-3.992 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.236.236 0 0 1 .02-.022z"/>
            </svg>
        `;

        const checkIconBlank = `
            <svg checkicon class="float-left string-row-icon" width="16px" height="16px" viewBox="0 0 16 16" fill="currentColor" opacity="0.0" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" d="M10.97 4.97a.75.75 0 0 1 1.071 1.05l-3.992 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.236.236 0 0 1 .02-.022z"/>
            </svg>
        `;

        const infoIconTemplate = `
            <svg id="%str-info-icon-identifier%" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" class="float-right string-row-info string-row-icon" fill="currentColor">
                <title></title>
                <path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"></path>
            </svg>
        `;

        let text = $('#search-text').val();
        if (text) {
            text = text.trim().toLowerCase();
        }
        const arr = strings || [];
        const filteredStrings = (!text || text.length === 0)
            ? arr
            : arr.filter(str =>
                str.text.toLowerCase().includes(text) ||
                (str.identifier && str.identifier.toLowerCase().includes(text)) ||
                (str.context && str.context.toLowerCase().includes(text)) ||
                (str.labelIds && str.labelIds.length > 0 && labels.filter(l => str.labelIds.includes(l.id)).some(l => l.title.toLowerCase().includes(text)))
            );
        const limited = filteredStrings.length > 1000 ? filteredStrings.slice(0, 1000) : filteredStrings;
        return window.postMessage('getUsedStrings')
            .then((e) => {
                const usedStrings = e[0];
                const texts = limited.map(str => {
                    const isUsed = usedStrings.includes(str.id);
                    const file = files.find(f => f.id === str.fileId);
                    const editable = file && editableFileTypes.includes(file.type);
                    const infoIcon = infoIconTemplate.replace('%str-info-icon-identifier%', `str-info-icon-${str.id}`);
                    return `
                        ${isUsed ? checkIcon : checkIconBlank}${infoIcon}${editable ? editIcon : ''}
                        <p
                            class="string-row"
                            onclick="useString(this)"
                            ${isUsed ? 'oncontextmenu="deselectString(this);return false;"' : ''}
                            int-id="${str.id}"
                            ${!!str.identifier ? `str-id="${str.identifier}"` : ''}
                        >
                        </p>
                    `;
                });
                $('#strings-container').find('p, svg').remove().end().append(texts);
                limited.forEach(str => {
                    //adding text here via "text" method to avoid issues with strings which contain html tags
                    const file = files.find(f => f.id === str.fileId);
                    let infoText = `Context:\n${str.context}\n\nIdentifier:\n${str.identifier ? str.identifier : str.text}\n\nFile:\n${file ? file.name : ''}`;
                    if (str.labelIds && str.labelIds.length > 0) {
                        infoText += `\n\nLabels:\n${labels.filter(l => str.labelIds.includes(l.id)).map(l => l.title).join(',')}`;
                    }
                    $('#strings-container').find(`p[int-id=${str.id}]`).text(str.text);
                    $('#strings-container').find(`svg[id=str-info-icon-${str.id}`).find('title').text(infoText);
                });
            });
    }

    //texts
    function loadText() {
        window.postMessage('getTexts').then(e => {
            const uiTexts = e[0].ui;
            validationMessages = uiTexts.validation;
            allLanguagesOption = uiTexts.labels.allLanguagesOption;
            noBranchOption = uiTexts.labels.noBranchOption;
            const labels = $('[crowdin-ui-text-label]');
            for (let i = 0; i < labels.length; i++) {
                const label = $(labels[i]);
                const key = label.attr('crowdin-ui-text-label');
                label.text(uiTexts.labels[key] || '');
            }
            const detailsArr = $('[crowdin-ui-text-details]');
            for (let i = 0; i < detailsArr.length; i++) {
                const details = $(detailsArr[i]);
                const key = details.attr('crowdin-ui-text-details');
                details.attr('title', (uiTexts.details[key] || ''));
            }
            applyCustomText(uiTexts.custom);
        });
    }

    function applyCustomText(texts) {
        $('#string-files').attr('title', texts.stringFilesSelectPlaceholder);
        $('#string-labels').attr('title', texts.stringLabelsSelectPlaceholder);
    }

    loadText();
</script>

</html>
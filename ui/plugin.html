<html>

<head>
    <link rel="stylesheet" href="../bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../styles.css">
    <script src="../jquery/dist/jquery.min.js"></script>
    <script src="../bootstrap/dist/js/bootstrap.min.js"></script>
</head>

<body>
    <nav class="navbar navbar-expand navbar-light plugin-tabs">
        <div class="container-fluid">
            <ul class="nav navbar-nav native-tabs">
                <li class="nav-item" data-toggle="tooltip" data-id="settings" placement="bottom"
                    title="Send designs for translations to Crowdin and upload translated copies back to Sketch. Use for translating static pages, like banners and brochures.">
                    <a id="translation-nav" class="nav-link" href="#"
                        onclick="openModal('translation');getLanguages();">Translation</a>
                </li>
                <li class="nav-item" data-toggle="tooltip" data-placement="bottom"
                    title="Use this mode to work with dynamic designs, including product UI.Get real source texts from Crowdin, use them in your designs, and upload screenshots of the artboards to provide context for translators.">
                    <a id="strings-mode-nav" class="nav-link" href="#"
                        onclick="openModal('strings-mode');getStrings();">Strings</a>
                </li>
                <li class="nav-item">
                    <a id="settings-nav" class="nav-link active" href="#" onclick="openModal('settings')">Settings</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right pr-2">
                <a class="link small" href="#" onclick="contactUsClick()">Contact Us</a>
            </ul>
        </div>
    </nav>
    <main role="main">
        <div class="container" id="settings">
            <form>
                <div class="form-group project-select d-flex flex-row">
                    <label>Select Project:</label>
                    <div class="project-select-holder ml-2">
                        <select id="projects" onchange="saveProject()"></select>
                    </div>
                </div>
                <fieldset>
                    <label class="fieldset-label">Connection Details</label>
                    <div class="form-group">
                        <label>Personal Access Token:</label>
                        <input type="text" class="form-control" id="token">
                        <p class="form-text text-muted help-text mb-3">
                            You can generate it in your Crowdin Account Settings
                        </p>
                    </div>
                    <div class="form-group">
                        <label>Organization</label>
                        <input type="text" class="form-control" id="organization">
                        <p class="form-text text-muted help-text">
                            Specify organization domain name (for Crowdin Enterprise only).
                            If you connect Crowdin account, leave the field empty
                        </p>
                        <button type="button" class="btn btn-primary btn-sm" onclick="saveCredentials()">Connect to
                            Crowdin</button>
                    </div>
                </fieldset>
            </form>
        </div>

        <div class="container" id="strings-mode" style="display: none;">
            <form>
                <div class="form-group" id="list-strings">
                    <div class="search-wrapper">
                        <input type="search" id="search-text" class="w-100" oninput="search()" placeholder="Search">
                    </div>
                    <div id="strings-container" class="strings-container mt-3 bordered">
                    </div>
                    <p class="form-text text-muted help-text">
                        Use source string for you text component in design
                    </p>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="openAddString();">Add
                        string</button>
                </div>
                <div class="form-group" id="edit-string" style="display: none;">
                    <div class="form-group">
                        <input type="text" class="form-control" id="string-text" placeholder="text">
                    </div>
                    <div id="new-string-form" style="display: none;">
                        <div class="form-group">
                            <div class="form-row">
                                <div class="col-4">
                                    <label>Identifier</label>
                                </div>
                                <div class="col-8">
                                    <input type="text" class="form-control" id="string-identifier"
                                        placeholder="identifier">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="form-row">
                                <div class="col-4">
                                    <label>File</label>
                                </div>
                                <div class="col-8">
                                    <select id="string-files" class="ml-1" style="width: 100%;">
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="col">
                            <button type="button" class="btn btn-secondary btn-sm mb-2"
                                onclick="saveString();">Save</button>
                            <button type="button" class="btn btn-secondary btn-sm mb-2"
                                onclick="cancelEditString();">Cancel</button>
                        </div>
                        <div class="col">
                            <button type="button" class="btn btn-secondary btn-sm mb-2 float-right"
                                onclick="deleteString();">Delete</button>
                        </div>
                    </div>
                </div>
                <hr class="my-2">
                <div class="form-group">
                    <button type="button" class="btn btn-secondary btn-sm mb-2" onclick="uploadScreenshots()">Upload
                        Screenshots</button>
                    <p class="form-text text-muted help-text">Send Artboards Screenshots for selected page with tagged
                        strings</p>
                </div>
                <fieldset>
                    <label class="fieldset-label">Preview strings</label>
                    <div class="form-group">
                        <div class="form-row">
                            <div class="col">
                                <select id="languages-preview" class="ml-1"></select>
                            </div>
                            <div class="col">
                                <button type="button" class="btn btn-secondary btn-sm btn-block"
                                    onclick="stringsPreview()">Preview</button>
                            </div>
                        </div>
                    </div>
                </fieldset>
            </form>
        </div>

        <div class="container" id="translation" style="display: none;">
            <form>
                <fieldset>
                    <label class="fieldset-label">Send Texts</label>
                    <div class="form-group">
                        <label>Send texts for selected:</label>
                        <div class="form-row">
                            <div class="col">
                                <button type="button" class="btn btn-secondary btn-sm btn-block"
                                    onclick="sendStrings(true)">Page</button>
                            </div>
                            <div class="col">
                                <button type="button" class="btn btn-secondary btn-sm btn-block"
                                    onclick="sendStrings(false)">Artboard</button>
                            </div>
                        </div>
                    </div>
                </fieldset>
                <fieldset>
                    <label class="fieldset-label">Get Translations</label>
                    <div class="form-group">
                        <label>Language:</label>
                        <select id="languages" class="ml-1"></select>
                    </div>
                    <div class="form-group">
                        <label>Upload translations for selected:</label>
                        <div class="form-row">
                            <div class="col">
                                <button type="button" class="btn btn-secondary btn-sm btn-block"
                                    onclick="translateComponent(true)">Page</button>
                            </div>
                            <div class="col">
                                <button type="button" class="btn btn-secondary btn-sm btn-block"
                                    onclick="translateComponent(false)">Artboard</button>
                            </div>
                        </div>
                    </div>
                </fieldset>

            </form>
        </div>

        <div id="spinner" class="modal fade bd-example-modal-lg show" data-backdrop="static" data-keyboard="false"
            tabindex="-1" style="display: none;" aria-modal="true">
            <div class="modal-dialog modal-sm">
                <div class="modal-content" style="width: 48px">
                    <div class="spinner-border" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer" id="footer"></div>
    </main>
    <div id="modalFade" class="modal-backdrop fade show" style="display: none;"></div>
</body>

<script>

    var openedModal = 'settings';
    var languages;
    var strings;
    var files;
    var openedString;

    getCredentials();
    getProjects();

    function openModal(modal) {
        if (openedModal === modal) {
            return;
        }
        $(`#${openedModal}`).hide();
        $(`#${openedModal}-nav`).removeClass('active');
        $(`#${modal}`).show();
        $(`#${modal}-nav`).addClass('active');
        openedModal = modal;
    }

    function showLoading() {
        $('#spinner').show();
        $('#modalFade').show();
    }

    function hideLoading() {
        $('#spinner').hide();
        $('#modalFade').hide();
    }

    function contactUsClick() {
        window.postMessage('contactUs');
    }

    function getCredentials() {
        return window.postMessage('getCredentials').then(creds => {
            $('#organization').val(creds[0].organization);
            $('#token').val(creds[0].token);
        });
    }

    function getProjects() {
        showLoading();
        window.postMessage('getProjects')
            .then(info => {
                const projectsInfo = info[0];
                const options = projectsInfo.projects.map(pr => {
                    if (pr.id === projectsInfo.selectedProjectId) {
                        return `<option value="${pr.id}" selected>${pr.name}</option>`;
                    } else {
                        return `<option value="${pr.id}">${pr.name}</option>`;
                    }
                }).join('');
                $('#projects').find('option').remove().end().append(options);
            })
            .then(hideLoading);
    }

    function saveCredentials() {
        const token = $('#token').val();
        const organization = $('#organization').val();
        window.postMessage('saveCredentials', { token, organization })
            .then(getCredentials)
            .then(getProjects)
            .then(clearStorage);
    }

    function saveProject() {
        const projectId = $('#projects option:selected').val();
        window.postMessage('saveProject', projectId)
            .then(clearStorage);
    }

    function getLanguages() {
        if (!languages) {
            showLoading();
            return window.postMessage('getLanguages')
                .then(res => {
                    languages = res[0];
                    let options = '<option value="-1">All Languages</option>';
                    options += languages.map(lan => {
                        return `<option value="${lan.id}">${lan.name}</option>`;
                    }).join('');
                    $('#languages').find('option').remove().end().append(options);
                    $('#languages-preview').find('option').remove().end().append(options);
                })
                .then(hideLoading);
        }
    }

    function getFiles() {
        if (!files) {
            showLoading();
            return window.postMessage('getFiles')
                .then(res => {
                    files = res[0];
                    const options = files.map(file => {
                        return `<option value="${file.id}">${file.name}</option>`;
                    }).join('');
                    $('#string-files').find('option').remove().end().append(options);
                })
                .then(hideLoading);
        } else {
            return new Promise((res, rej) => {
                res();
            });
        }
    }

    function getStrings() {
        if (!strings) {
            showLoading();
            window.postMessage('getStrings')
                .then(res => {
                    strings = res[0];
                    search();
                })
                .then(() => {
                    if (!languages) {
                        return getLanguages();
                    } else {
                        hideLoading();
                    }
                });
        }
    }

    function translateComponent(wholePage) {
        showLoading();
        const languageId = Number($('#languages option:selected').val());
        window.postMessage('translate', languageId, wholePage).then(hideLoading);
    }

    function sendStrings(wholePage) {
        showLoading();
        window.postMessage('sendStrings', wholePage).then(hideLoading);
    }

    function useString(e) {
        showLoading();
        const id = Number($(e).attr('int-id'));
        const text = $(e).text().trim();
        window.postMessage('useString', { id, text }).then(hideLoading);
    }

    function uploadScreenshots() {
        showLoading();
        window.postMessage('uploadScreenshots').then(hideLoading);
    }

    function stringsPreview() {
        showLoading();
        const id = $('#languages-preview option:selected').val();
        const name = $('#languages-preview option:selected').text();
        window.postMessage('stringsPreview', { id, name }).then(hideLoading);
    }

    function clearStorage() {
        strings = undefined;
        languages = undefined;
        files = undefined;
        openedString = undefined;
    }

    function search() {
        const icon = `
            <svg class="float-right" onclick="openEditString(event, this);" width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-pencil" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" d="M11.293 1.293a1 1 0 0 1 1.414 0l2 2a1 1 0 0 1 0 1.414l-9 9a1 1 0 0 1-.39.242l-3 1a1 1 0 0 1-1.266-1.265l1-3a1 1 0 0 1 .242-.391l9-9zM12 2l2 2-9 9-3 1 1-3 9-9z"/>
                <path fill-rule="evenodd" d="M12.146 6.354l-2.5-2.5.708-.708 2.5 2.5-.707.708zM3 10v.5a.5.5 0 0 0 .5.5H4v.5a.5.5 0 0 0 .5.5H5v.5a.5.5 0 0 0 .5.5H6v-1.5a.5.5 0 0 0-.5-.5H5v-.5a.5.5 0 0 0-.5-.5H3z"/>
            </svg>
        `;

        let text = $('#search-text').val();
        if (text) {
            text = text.trim().toLowerCase();
        }
        const arr = strings || [];
        const filteredStrings = (!text || text.length === 0)
            ? arr
            : arr.filter(str => str.text.toLowerCase().includes(text));
        const texts = filteredStrings.map(str => `<p class="string-row" onclick="useString(this)" int-id="${str.id}">${str.text}${icon}</p>`)
        $('#strings-container').find('p').remove().end().append(texts);
    }

    function openEditString(event, element) {
        event.stopPropagation();
        const el = $(element);
        $('#list-strings').hide();
        $('#new-string-form').hide();
        $('#edit-string').show();
        const text = $(element).parent().text().trim();
        const id = Number($(element).parent().attr('int-id'));
        $('#string-text').val(text);
        openedString = id;
    }

    function openAddString() {
        getFiles().then(() => {
            $('#list-strings').hide();
            $('#new-string-form').show();
            $('#edit-string').show();
            $('#string-text').val('');
            $('#string-identifier').val('');
            openedString = undefined;
        });
    }

    function cancelEditString() {
        $('#list-strings').show();
        $('#edit-string').hide();
    }

    function deleteString() {
        if (openedString) {
            showLoading();
            window.postMessage('deleteString', { id: openedString })
                .then(e => {
                    if (!e[0].error) {
                        strings = strings.filter(e => e.id !== openedString);
                        cancelEditString();
                        search();
                    }
                    hideLoading();
                });
        } else {
            cancelEditString();
        }
    }

    function saveString() {
        const text = $('#string-text').val();
        if (openedString) {
            showLoading();
            window.postMessage('editString', { id: openedString, text })
                .then(e => {
                    if (!e[0].error) {
                        strings = strings.map(s => {
                            if (s.id === openedString) {
                                s.text = text;
                            }
                            return s;
                        });
                        cancelEditString();
                        search();
                    }
                    hideLoading();
                });
        } else {
            showLoading();
            const req = {
                text,
                identifier: $('#string-identifier').val(),
                fileId: Number($('#string-files option:selected').val())
            };
            window.postMessage('addString', req)
                .then(e => {
                    if (!e[0].error) {
                        strings.push({
                            id: e[0].data.id,
                            text: text
                        });
                        cancelEditString();
                        search();
                    }
                    hideLoading();
                });
        }
    }
</script>

</html>